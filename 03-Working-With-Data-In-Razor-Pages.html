<!DOCTYPE html>
<html>
<head>
<title>03-Working-With-Data-In-Razor-Pages.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="working-with-data-in-razor-pages">Working with Data in Razor Pages</h1>
<p>Code: <code>Sandbox\Razor\MovieApp</code></p>
<h2 id="adding-entity-framework">Adding Entity Framework</h2>
<h3 id="steps">Steps</h3>
<ol>
<li>Create new database</li>
<li>Get connection string</li>
<li>Configure Entity Framework Core</li>
</ol>
<h3 id="nuget-packages">NuGet packages</h3>
<ul>
<li>Microsoft.EntityFrameworkCore</li>
<li>Microsoft.EntityFrameworkCore.SqlServer</li>
<li>Microsoft.EntityFrameworkCore.Tools</li>
</ul>
<h3 id="create-sql-server-database">Create SQL Server database</h3>
<p>In Visual Studio go to <code>Server Explorer</code> and add a new database. It will ask for the Server name (<code>TIGER</code>) and we want to use <em>Windows Authentication</em>.</p>
<p>In <em>Connect to a database</em> name it <code>MovieApp</code>.</p>
<p>Click <code>Ok</code>.</p>
<p>In the Server Explorer data connection you will see.</p>
<pre class="hljs"><code><div>    tiger.MovieApp.dbo
</div></code></pre>
<p>Right-Click the <code>MovieApp</code> database and look at <em>Properties</em> you will see a <em>Connection string</em> so copy this.</p>
<p>To store the connection string use the <code>appsettings.json</code> file.</p>
<pre class="hljs"><code><div>    {
      <span class="hljs-attr">"Logging"</span>: {
        <span class="hljs-attr">"LogLevel"</span>: {
          <span class="hljs-attr">"Default"</span>: <span class="hljs-string">"Information"</span>,
          <span class="hljs-attr">"Microsoft.AspNetCore"</span>: <span class="hljs-string">"Warning"</span>
        }
      },
      <span class="hljs-attr">"AllowedHosts"</span>: <span class="hljs-string">"*"</span>,
      <span class="hljs-attr">"ConnectionStrings"</span>: {
        <span class="hljs-attr">"MovieApp"</span>: <span class="hljs-string">"Data Source=TIGER;Initial Catalog=MovieApp;Integrated Security=True"</span>
      }
    }
</div></code></pre>
<p><strong>Note:</strong> you can add multiple connection strings in here, each separated by a comma.</p>
<h3 id="add-nuget-packages">Add NuGet packages</h3>
<p>Open the NuGet console.</p>
<pre class="hljs"><code><div>    <span class="hljs-built_in">Install-Package</span> Microsoft.EntityFrameworkCore
    
    <span class="hljs-built_in">Install-Package</span> Microsoft.EntityFrameworkCore.SqlServer

    <span class="hljs-built_in">Install-Package</span> Microsoft.EntityFrameworkCore.Tools
</div></code></pre>
<h3 id="create-the-dbcontext">Create the DbContext</h3>
<p>In the <code>Data</code> folder create a new class named <code>MovieAppDbContext.cs</code>. This class is going to serve as the translator between the SQL and our entities.</p>
<p>In the class we need to inherit from the base class <code>DbContext</code>.</p>
<p>Add the using statement <code>using Microsoft.EntityFrameworkCore;</code>.</p>
<p>Create a <code>ctor</code> constructor named <code>MovieAppDbContext()</code>.</p>
<pre class="hljs"><code><div>    <span class="hljs-keyword">using</span> Microsoft.EntityFrameworkCore;
    <span class="hljs-keyword">using</span> MoviesApp.Data.Models;

    <span class="hljs-keyword">namespace</span> <span class="hljs-title">MoviesApp.Data</span>
    {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MovieAppDbContext</span>: <span class="hljs-title">DbContext</span>
        {
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MovieAppDbContext</span>(<span class="hljs-params">DbContextOptions&lt;MovieAppDbContext&gt; options</span>): <span class="hljs-title">base</span>(<span class="hljs-params">options</span>)</span>
            {

            }

            <span class="hljs-keyword">public</span> DbSet&lt;Movie&gt; Movies { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        }
    }
</div></code></pre>
<p>We have injected the <code>DbContextOptions</code> into our constructor and we need to add C# class <code>MovieAppDbContext</code> and name it <code>options</code> which inherits from <code>base(options)</code>.</p>
<p>We also need to create a <code>DbSet&lt;&gt;</code> and this will be used by Entity Framework Core to create the table in our database which will be derived from our <code>Movie</code> model. We import the Namespace from Movie (<code>MoviesApp.Data.Models</code>). The table name will be <code>Movies</code> and we need to <code>get</code> and <code>set</code> data to and from the database.</p>
<p>Now we need to configure our context to be able to work with the Entity Framework Core and the SQL Server database. To do this we need to go to the <code>Program.cs</code> class file and add the following statement below the <code>AddRazorPages()</code> statement.</p>
<pre class="hljs"><code><div>    builder.Services.AddDbContext&lt;MovieAppDbContext&gt;(options =&gt; 
        options.UseSqlServer(builder.Configuration.GetConnectionString(<span class="hljs-string">"MovieApp"</span>)));
</div></code></pre>
<p>We add a <code>builder.Services.AddDbContext</code> and use the <code>MovieAppDbContext</code> context. In our options we need to tell the services that we are using <code>SqlServer</code>. To access our connection string we use <code>builder.Configuration.GetConnectionString</code> to get the configuration string with our reference to the <code>MovieApp</code> connection string from <code>appsettings.json</code>.</p>
<h3 id="adding-a-migration">Adding a migration</h3>
<p>This will build the database for us using Entity Framework Core and SQL Server.</p>
<p><strong>Note:</strong> before you run the following you should compile your project and make sure you have no compile errors.</p>
<p>Go to the NuGet console.</p>
<pre class="hljs"><code><div>    <span class="hljs-built_in">Add-Migration</span> Initial
</div></code></pre>
<p>Where <code>Initial</code> is the name of the migration.</p>
<p>This creates the database.</p>
<p>If you look in the migrations folder you will see <code>20220720063743_Initial.cs</code> which is the script to create the table in our database. To do this run the following NuGet command.</p>
<pre class="hljs"><code><div>    <span class="hljs-built_in">Update-Database</span>
</div></code></pre>
<p>This creates the <code>Movie</code> table.</p>
<p>In the Server Explorer in Visual Studio go to the database and open the tables. You will see the <code>Movie</code> table. From here you can <code>Show Table Data</code> to see if there is any table rows. In our case there won't be.</p>
<h2 id="adding-and-storing-data-in-a-database">Adding and storing data in a database</h2>
<p>We are going to add a new <code>Movie</code> into the database.</p>
<p>In our <code>AddMovie</code> PageModel we need to create a constructor and add our database context.</p>
<pre class="hljs"><code><div>    <span class="hljs-keyword">private</span> MovieAppDbContext _context;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AddMovieModel</span>(<span class="hljs-params">MovieAppDbContext context</span>)</span>
    {
        _context = context;
    }
</div></code></pre>
<p>Now, in our <code>OnPost()</code> method we create a new <code>Movie</code> object to save the data that has been posted.</p>
<pre class="hljs"><code><div>    <span class="hljs-function"><span class="hljs-keyword">public</span> IActionResult <span class="hljs-title">OnPost</span>(<span class="hljs-params"></span>)</span>
    {
        <span class="hljs-keyword">string</span> <span class="hljs-keyword">value</span> = <span class="hljs-string">$"<span class="hljs-subst">{Movie.Title}</span> - <span class="hljs-subst">{Movie.Rate}</span>/10 - <span class="hljs-subst">{Movie.Description}</span>"</span>;
        
        <span class="hljs-keyword">if</span> (!ModelState.IsValid)
        {
            <span class="hljs-keyword">return</span> Page();
        }

        Message = <span class="hljs-keyword">value</span>;
        
        <span class="hljs-keyword">var</span> movie = <span class="hljs-keyword">new</span> Movie()
        {
            Title = Movie.Title,
            Rate = Movie.Rate,
            Description = Movie.Description
        };
        
        _context.Movies.Add(movie);
        _context.SaveChanges();
        
        <span class="hljs-keyword">return</span> Redirect(<span class="hljs-string">"Movies"</span>);
    }
</div></code></pre>
<p>Once we have added our data to our <code>Movie</code> object add it to the context, <code>_context.Movies.Add(movie)</code> and save the changes to the database with <code>_context.SaveChanges()</code>.</p>
<p>We can now use server explorer to view our <code>Movie</code> table and we see that it has saved a record.</p>
<p><img src="assets/images/save-to-database.jpg" alt="Add a row to the table" title="Add a row to the table"></p>
<p>We are then redirected to the <code>Movies</code> page. We don't see the new <code>Movie</code> object on the page because the data is hardcoded. That will be our next task.</p>
<h2 id="getting-data-from-a-database">Getting data from a database</h2>
<p>To be able to see the data in our <code>Movies</code> list go to <code>Movies.cshtml.cs</code>. Remove the hardcoded data from the <code>OnGet()</code> method.</p>
<h3 id="moviescshtmlcs">Movies.cshtml.cs</h3>
<pre class="hljs"><code><div>    <span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;
    <span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc.RazorPages;
    <span class="hljs-keyword">using</span> MoviesApp.Data;
    <span class="hljs-keyword">using</span> MoviesApp.Data.Models;

    <span class="hljs-keyword">namespace</span> <span class="hljs-title">MoviesApp.Pages</span>
    {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MoviesModel</span> : <span class="hljs-title">PageModel</span>
        {
            <span class="hljs-keyword">public</span> List&lt;Movie&gt;? Movies { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

            [<span class="hljs-meta">TempData</span>]
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Message { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

            <span class="hljs-keyword">private</span> MovieAppDbContext _context;

            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MoviesModel</span>(<span class="hljs-params">MovieAppDbContext context</span>)</span>
            {
                _context = context;
            }

            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnGet</span>(<span class="hljs-params"></span>)</span>
            {
                Movies = _context.Movies.ToList();
            }
        }
    }
</div></code></pre>
<p>We add a constructor to get the context and then use <code>_context.Movies.ToList()</code> to pass back a list of <code>Movies</code>.</p>
<p>Now run the application again and we will see that there is one Movie in our <code>Movies</code> Razor page.</p>
<p><img src="assets/images/movies-list-from-database.jpg" alt="Movies list" title="Movies list"></p>
<p>Add some more movies to see them in the list.</p>
<p><img src="assets/images/more-movies-added.jpg" alt="Movies list" title="Movies list"></p>
<h2 id="getting-data-by-id-from-the-database">Getting data by ID from the database</h2>

</body>
</html>
